<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teachable Machine + Arduino</title>
</head>
<body>

    <h1>Teachable Machine Image Model + Arduino</h1>

    <button type="button" onclick="init()">Start Webcam & Model</button>
    <button type="button" onclick="connectSerial()">Connect to Arduino</button>

    <div id="webcam-container"></div>
    <div id="label-container"></div>

    <!-- TensorFlow.js and Teachable Machine Image Library -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        const URL = "./my_model/";

        let model, webcam, labelContainer, maxPredictions;
        let port, writer, lastCommand = "";

        // Load model and webcam
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        // Predict from webcam and send to Arduino
        async function predict() {
            const prediction = await model.predict(webcam.canvas);

            let highestProb = 0;
            let predictedClass = "";

            for (let i = 0; i < maxPredictions; i++) {
                const prob = prediction[i].probability;
                const className = prediction[i].className;

                if (prob > highestProb) {
                    highestProb = prob;
                    predictedClass = className;
                }

                const classPrediction = className + ": " + prob.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }

            if (highestProb > 0.9) {
                let command = "";

                // ⚠️ Replace with your actual class labels
                if (predictedClass === "Class 1") {
                    command = "1";
                } else if (predictedClass === "Class 2") {
                    command = "0";
                }

                if (writer && command !== lastCommand) {
                    await writer.write(command);
                    lastCommand = command;
                }
            }
        }

        // Connect to Arduino via Web Serial
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                const encoder = new TextEncoderStream();
                encoder.readable.pipeTo(port.writable);
                writer = encoder.writable.getWriter();
                console.log("✅ Serial connected to Arduino.");
            } catch (err) {
                console.error("❌ Serial connection failed:", err);
            }
        }
    </script>

</body>
</html>
